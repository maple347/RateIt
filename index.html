<!DOCTYPE html>
<html lang="ru">
<head>
    <!-- ... (ваш существующий HTML-код) ... -->
</head>
<body>
    <!-- ... (ваш существующий HTML-код) ... -->

    <script src="https://cdn.jsdelivr.net/npm/ @supabase/supabase-js"></script>
    <script>
        // Настройка Supabase
        const supabaseUrl = 'https://cspycataceyozqgkkeny.supabase.co '; // Ваш URL
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...'; // Ваш Public API Key
        const supabase = supabase.createClient(supabaseUrl, supabaseKey);

        // Загрузка данных
        async function loadRatings() {
            try {
                const { data } = await supabase.from('ratings').select('*');
                const list = document.getElementById('ratingList');
                list.innerHTML = '';
                data.forEach(item => {
                    const li = document.createElement('li');
                    li.className = 'rating-item';
                    li.innerHTML = `
                        <div class="book-title">${item.title}</div>
                        <div class="book-author">${item.author}</div>
                        <div>★${item.rating} (голосов: ${item.votes})</div>
                    `;
                    list.appendChild(li);
                });
            } catch (error) {
                console.error('Ошибка загрузки:', error);
                alert('Не удалось загрузить данные. Проверьте связь с Supabase.');
            }
        }

        // Добавление оценки
        async function addRating() {
            const title = document.getElementById('bookTitle').value.trim();
            const author = document.getElementById('bookAuthor').value.trim();
            const rating = document.getElementById('bookRating').value;

            if (!title || !author) {
                alert('Введите название и автора!');
                return;
            }

            try {
                // Проверяем, существует ли книга
                const { data: existingData } = await supabase
                    .from('ratings')
                    .select('*')
                    .eq('title', title)
                    .eq('author', author)
                    .single();

                if (existingData) {
                    // Обновляем существующую запись
                    const newVotes = existingData.votes + 1;
                    const newRating = (existingData.rating * existingData.votes + parseInt(rating)) / newVotes;

                    await supabase
                        .from('ratings')
                        .update({ rating: newRating, votes: newVotes })
                        .eq('id', existingData.id);
                } else {
                    // Создаем новую запись
                    await supabase
                        .from('ratings')
                        .insert([{ title, author, rating: parseInt(rating), votes: 1 }]);
                }

                // Очистка формы и обновление списка
                document.getElementById('bookTitle').value = '';
                document.getElementById('bookAuthor').value = '';
                loadRatings();
                alert('Оценка добавлена!');
            } catch (error) {
                console.error('Ошибка сохранения:', error);
                alert('Не удалось отправить оценку. Проверьте политики Supabase.');
            }
        }

        // Инициализация
        loadRatings();
    </script>
</body>
</html>
